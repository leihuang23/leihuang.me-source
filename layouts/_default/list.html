{{- define "main" }} {{- if (and site.Params.profileMode.enabled .IsHome) }} {{-
partial "index_profile.html" . }} {{- else }} {{/* if not profileMode */}} {{-
if not .IsHome | and .Title }}
<header class="page-header">
  {{- partial "breadcrumbs.html" . }}
  <h1>
    {{ .Title }} {{- if and (or (eq .Kind `term`) (eq .Kind `section`)) (.Param
    "ShowRssButtonInSectionTermList") }} {{- with .OutputFormats.Get "rss" }}
    <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        height="23"
      >
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
    {{- end }} {{- end }}
  </h1>
  {{- if .Description }}
  <div class="post-description">{{ .Description | markdownify }}</div>
  {{- end }}
</header>
{{- end }} {{- if .Content }}
<div class="post-content">
  {{- if not (.Param "disableAnchoredHeadings") }} {{- partial
  "anchored_headings.html" .Content -}} {{- else }}{{ .Content }}{{ end }}
</div>
{{- end }} {{- $pages := union .RegularPages .Sections }} {{- if .IsHome }} {{-
$pages = where site.RegularPages "Type" "in" site.Params.mainSections }} {{-
$pages = where $pages "Params.hiddenInHomeList" "!=" "true" }} {{- end }} {{-
$paginator := .Paginate $pages }} {{- if and .IsHome site.Params.homeInfoParams
(eq $paginator.PageNumber 1) }}
<div id="canvas-container">
  <button id="fullScreenBtn" title="Toggle fullscreen">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      width="24"
      height="24"
    >
      <path
        fill="currentColor"
        d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"
      />
    </svg>
  </button>
  <canvas id="canvas1"></canvas>
</div>
<style>
  #canvas-container {
    position: relative;
  }
  #canvas1 {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    background: #111;
  }
  #fullScreenBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #111;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 6px 12px;
    z-index: 10;
  }
  .fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background-color: #111;
  }
</style>
<script>
  const canvas = document.getElementById("canvas1");
  const ctx = canvas.getContext("2d");
  const canvasContainer = document.getElementById("canvas-container");
  const fullScreenBtn = document.getElementById("fullScreenBtn");

  fullScreenBtn.addEventListener("click", function () {
    canvasContainer.classList.toggle("fullscreen");
    requestAnimationFrame(() => {
      window.dispatchEvent(new Event("resize"));
    });
  });
  const coordinates = [
    [100, 107],
    [99, 107],
    [100, 110],
    [100, 115],
    [101, 126],
    [101, 138],
    [101, 151],
    [101, 163],
    [102, 175],
    [102, 190],
    [102, 203],
    [101, 216],
    [100, 226],
    [98, 236],
    [95, 247],
    [92, 258],
    [87, 270],
    [82, 281],
    [77, 291],
    [73, 299],
    [68, 305],
    [63, 309],
    [58, 313],
    [53, 316],
    [49, 317],
    [45, 316],
    [42, 314],
    [39, 310],
    [36, 304],
    [34, 296],
    [32, 288],
    [32, 281],
    [33, 275],
    [34, 269],
    [37, 263],
    [41, 257],
    [45, 251],
    [51, 247],
    [56, 243],
    [61, 241],
    [66, 239],
    [71, 237],
    [77, 236],
    [82, 237],
    [87, 238],
    [93, 239],
    [98, 241],
    [104, 242],
    [109, 243],
    [115, 245],
    [121, 246],
    [126, 246],
    [131, 246],
    [136, 245],
    [141, 242],
    [146, 238],
    [152, 232],
    [157, 225],
    [162, 217],
    [166, 209],
    [170, 201],
    [175, 192],
    [180, 182],
    [184, 173],
    [187, 164],
    [189, 156],
    [190, 149],
    [192, 141],
    [193, 135],
    [194, 130],
    [193, 126],
    [192, 124],
    [191, 122],
    [190, 122],
    [189, 124],
    [188, 126],
    [187, 129],
    [185, 133],
    [183, 139],
    [181, 147],
    [177, 157],
    [174, 166],
    [171, 174],
    [169, 181],
    [167, 189],
    [165, 198],
    [163, 206],
    [161, 213],
    [159, 220],
    [158, 227],
    [157, 234],
    [156, 241],
    [155, 249],
    [154, 255],
    [153, 260],
    [153, 263],
    [153, 268],
    [152, 273],
    [151, 279],
    [150, 284],
    [149, 289],
    [149, 292],
    [149, 296],
    [148, 301],
    [147, 306],
    [147, 310],
    [147, 314],
    [147, 317],
    [147, 319],
    [147, 322],
    [147, 326],
    [147, 330],
    [147, 332],
    [147, 333],
    [147, 333],
    [147, 332],
    [148, 329],
    [149, 325],
    [151, 319],
    [154, 313],
    [158, 306],
    [162, 301],
    [165, 297],
    [168, 295],
    [172, 292],
    [176, 290],
    [180, 288],
    [185, 286],
    [190, 284],
    [196, 282],
    [202, 280],
    [208, 279],
    [214, 278],
    [220, 277],
    [226, 276],
    [231, 275],
    [236, 273],
    [240, 271],
    [243, 268],
    [246, 266],
    [246, 263],
    [246, 260],
    [244, 256],
    [241, 251],
    [236, 246],
    [229, 242],
    [221, 241],
    [214, 242],
    [208, 245],
    [203, 248],
    [197, 253],
    [193, 259],
    [190, 266],
    [189, 274],
    [188, 282],
    [188, 290],
    [189, 298],
    [191, 306],
    [194, 313],
    [198, 318],
    [202, 321],
    [207, 322],
    [212, 323],
    [217, 322],
    [223, 320],
    [230, 316],
    [237, 311],
    [244, 305],
    [251, 298],
    [259, 290],
    [268, 281],
    [277, 272],
    [285, 263],
    [292, 254],
    [299, 246],
    [305, 239],
    [310, 232],
    [315, 225],
    [320, 217],
    [326, 210],
    [331, 203],
    [335, 197],
    [340, 190],
    [344, 183],
    [348, 176],
    [351, 171],
    [353, 166],
    [355, 161],
    [356, 157],
    [356, 154],
    [355, 151],
    [353, 149],
    [351, 147],
    [347, 146],
    [343, 145],
    [339, 144],
    [335, 145],
    [331, 146],
    [327, 148],
    [323, 151],
    [320, 155],
    [316, 160],
    [312, 166],
    [309, 172],
    [307, 178],
    [304, 184],
    [301, 192],
    [298, 200],
    [295, 209],
    [293, 218],
    [290, 227],
    [287, 236],
    [285, 244],
    [283, 253],
    [281, 260],
    [280, 267],
    [279, 275],
    [279, 283],
    [280, 290],
    [281, 295],
    [282, 300],
    [285, 304],
    [288, 307],
    [291, 309],
    [295, 310],
    [300, 311],
    [304, 312],
    [309, 312],
    [314, 311],
    [319, 309],
    [324, 305],
    [330, 301],
    [336, 297],
    [342, 292],
    [350, 286],
    [358, 279],
    [366, 271],
    [373, 264],
    [380, 255],
    [388, 246],
    [396, 236],
    [402, 227],
    [408, 218],
    [414, 210],
    [419, 202],
    [423, 194],
    [426, 186],
    [430, 177],
    [432, 168],
    [434, 160],
    [433, 155],
    [432, 152],
    [430, 149],
    [428, 148],
    [425, 147],
    [422, 147],
    [418, 148],
    [415, 150],
    [412, 153],
    [409, 157],
    [406, 163],
    [402, 169],
    [398, 177],
    [395, 185],
    [392, 194],
    [389, 203],
    [385, 212],
    [382, 221],
    [379, 230],
    [376, 238],
    [373, 247],
    [371, 256],
    [370, 265],
    [369, 272],
    [369, 280],
    [369, 287],
    [369, 294],
    [370, 299],
    [372, 304],
    [374, 308],
    [377, 312],
    [380, 314],
    [384, 315],
    [388, 316],
    [393, 316],
    [398, 315],
    [403, 314],
    [407, 312],
    [412, 308],
    [417, 304],
    [421, 300],
    [425, 295],
    [429, 290],
    [433, 285],
    [438, 278],
    [443, 272],
    [448, 265],
    [451, 259],
    [455, 253],
    [460, 246],
    [464, 240],
    [467, 235],
    [468, 232],
    [468, 231],
    [468, 230],
    [468, 230],
    [467, 231],
    [466, 234],
    [464, 238],
    [462, 245],
    [459, 254],
    [457, 264],
    [456, 272],
    [456, 279],
    [457, 287],
    [458, 294],
    [460, 299],
    [463, 303],
    [467, 305],
    [471, 306],
    [476, 306],
    [481, 305],
    [486, 303],
    [491, 301],
    [496, 298],
    [502, 294],
    [506, 289],
    [510, 284],
    [512, 278],
    [513, 272],
    [513, 265],
    [513, 258],
    [512, 251],
    [510, 243],
    [505, 237],
    [499, 233],
    [493, 230],
    [486, 228],
    [481, 227],
    [476, 227],
    [472, 228],
    [469, 230],
    [467, 232],
    [466, 234],
    [466, 236],
    [466, 239],
    [467, 243],
    [469, 246],
    [472, 248],
    [476, 250],
    [481, 251],
    [487, 251],
    [492, 250],
    [499, 248],
    [505, 245],
    [511, 241],
  ];
  class List {
    static create(initialCapacity = 16) {
      const list = new List(initialCapacity);
      return new Proxy(list, {
        get(target, prop) {
          if (typeof prop === "string" && /^\d+$/.test(prop)) {
            return target.get(parseInt(prop));
          }
          return target[prop];
        },
      });
    }

    constructor(initialCapacity = 16) {
      this.initialCapacity = initialCapacity;
      this._capacity = initialCapacity;
      this._buffer = new Array(initialCapacity).fill(null);
      this._head = Math.floor(initialCapacity / 2); // Start in the middle
      this._tail = this._head - 1;
      this.length = 0;
    }

    /**
     * Prepends an item to the beginning of the list
     * @param {*} item - Item to prepend
     * @returns {number} New length of the list
     */
    prepend(item) {
      if (this._head === 0) this._resize();
      this._buffer[--this._head] = item;
      return ++this.length;
    }

    /**
     * Appends an item to the end of the list
     * @param {*} item - Item to append
     * @returns {number} New length of the list
     */
    append(item) {
      if (this._tail === this._capacity - 1) this._resize();
      this._buffer[++this._tail] = item;
      return ++this.length;
    }

    pop() {
      if (this.length === 0) return undefined;
      const item = this._buffer[this._tail];
      this._buffer[this._tail] = null;
      this._tail--;
      this.length--;
      return item;
    }

    /**
     * Gets an item at the specified index
     * @param {number} index - Zero-based index
     * @returns {*} Item at the index or undefined if out of bounds
     */
    get(index) {
      if (index < 0 || index >= this.length) return undefined;
      return this._buffer[this._head + index];
    }

    /**
     * Sets an item at the specified index
     * @param {number} index - Zero-based index
     * @param {*} value - Value to set
     * @returns {boolean} True if successful, false if index out of bounds
     */
    set(index, value) {
      if (index < 0 || index >= this.length) return false;
      this._buffer[this._head + index] = value;
      return true;
    }

    /**
     * Clears the list
     */
    clear() {
      const initialCapacity = this.initialCapacity;
      this._capacity = initialCapacity;
      this._buffer = new Array(initialCapacity).fill(null);
      this._head = Math.floor(initialCapacity / 2);
      this._tail = this._head - 1;
      this.length = 0;
    }

    /**
     * Resizes the internal buffer when needed
     * @private
     */
    _resize() {
      const newCapacity = this._capacity * 2;
      const newBuffer = new Array(newCapacity).fill(null);
      const newHead = Math.floor((newCapacity - this.length) / 2);

      // Copy elements to the new buffer
      for (let i = 0; i < this.length; i++) {
        newBuffer[newHead + i] = this._buffer[this._head + i];
      }

      this._buffer = newBuffer;
      this._head = newHead;
      this._tail = this._head + this.length - 1;
      this._capacity = newCapacity;
    }

    [Symbol.iterator]() {
      let index = 0;
      const list = this;

      return {
        next() {
          if (index < list.length) {
            return { value: list.get(index++), done: false };
          } else {
            return { done: true };
          }
        },
      };
    }

    forEach(callback) {
      for (let i = 0; i < this.length; i++) {
        callback(this.get(i), i);
      }
    }

    map(callback) {
      const result = List.create(this.length);
      for (let i = 0; i < this.length; i++) {
        result.append(callback(this.get(i), i));
      }
      return result;
    }
  }
  // Calculate bounds of the original coordinates
  let minX = Infinity,
    maxX = -Infinity,
    minY = Infinity,
    maxY = -Infinity;
  coordinates.forEach((pt) => {
    if (pt[0] < minX) minX = pt[0];
    if (pt[0] > maxX) maxX = pt[0];
    if (pt[1] < minY) minY = pt[1];
    if (pt[1] > maxY) maxY = pt[1];
  });

  const designWidth = maxX - minX;
  const designHeight = maxY - minY;
  // Calculate the center of the original drawing
  const designCenterX = minX + designWidth / 2;
  const designCenterY = minY + designHeight / 2;

  // Create complex points from raw coordinates (no initial scaling)
  const complexPoints = coordinates.map((pt) => ({
    re: pt[0],
    im: pt[1],
  }));

  // Discrete Fourier Transform (DFT)
  function dft(x) {
    const N = x.length;
    const X = [];
    for (let k = 0; k < N; k++) {
      let re = 0,
        im = 0;
      for (let n = 0; n < N; n++) {
        const phi = (2 * Math.PI * k * n) / N;
        // Multiply by e^(-i*phi) = cos(phi) - i*sin(phi)
        re += x[n].re * Math.cos(phi) + x[n].im * Math.sin(phi);
        im += -x[n].re * Math.sin(phi) + x[n].im * Math.cos(phi);
      }
      re /= N;
      im /= N;
      const freq = k;
      const amp = Math.hypot(re, im);
      const phase = Math.atan2(im, re);
      X.push({ re, im, freq, amp, phase });
    }
    return X;
  }

  // Compute Fourier coefficients and sort by amplitude (largest first)
  let fourier = dft(complexPoints);
  fourier.sort((a, b) => b.amp - a.amp);

  // Animation state variables
  let time = 0;
  const dt = (2 * Math.PI) / fourier.length; // Time step per frame
  let path = List.create(fourier.length);
  const animationSpeed = 1; // Lower = slower, 1.0 = original speed
  let lastFrameTime = 0;
  let animationFrameId = null; // To manage the animation loop

  // Function to resize the canvas and handle DPI scaling
  function resizeCanvas() {
    // Stop previous animation frame request if any
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }

    // Use parent width for responsiveness (minus padding)
    // const containerPadding = 28; // Match your CSS padding * 2 or desired spacing
    const newWidth = canvasContainer.clientWidth;

    const newHeight = Math.min(newWidth * (2 / 3), window.innerHeight);

    // Set the CSS size for the element's layout
    canvas.style.width = newWidth + "px";
    canvas.style.height = newHeight + "px";

    // Set the drawing surface resolution (important!)
    // Use devicePixelRatio for sharper rendering on high-DPI screens
    const dpr = window.devicePixelRatio || 1;
    canvas.width = newWidth * dpr;
    canvas.height = newHeight * dpr;

    // Scale the context once here to compensate for devicePixelRatio
    // This ensures 1 CSS pixel corresponds to 1 drawing unit before our dynamic scaling
    ctx.resetTransform(); // Clear previous transforms before scaling
    ctx.scale(dpr, dpr);

    // Reset drawing state
    path.clear();
    time = 0;
    lastFrameTime = 0; // Reset last frame time for smooth start

    // Restart the animation loop
    animationFrameId = requestAnimationFrame(draw);
  }

  // Function to draw the set of vectors and update the traced path
  function draw(currentTime) {
    // Control frame rate based on timing (optional, remove if full speed is okay)
    if (lastFrameTime === 0) lastFrameTime = currentTime;
    const elapsed = currentTime - lastFrameTime;

    // Only update if enough time has passed (for slower animation)
    if (elapsed > 1000 / 60 / animationSpeed) {
      lastFrameTime = currentTime; // Uncomment if using frame rate limiting

      // Use CSS dimensions for drawing logic before DPR scaling
      const cssWidth = parseFloat(canvas.style.width) || canvas.width;
      const cssHeight = parseFloat(canvas.style.height) || canvas.height;

      // Clear the canvas (considering the DPR scaling applied in resizeCanvas)
      // We need to clear the *physical* pixel area
      ctx.save();
      ctx.resetTransform(); // Temporarily remove DPR scaling for clearRect
      ctx.fillStyle = "#111";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore(); // Restore DPR scaling

      ctx.save(); // Save the DPR-scaled state

      // --- Scaling Logic ---
      // Calculate scale factors to fit the design within the CSS dimensions
      const scaleX = cssWidth / designWidth;
      const scaleY = cssHeight / designHeight;
      // Use the smaller scale factor to maintain aspect ratio and fit entirely
      // Multiply by a factor (e.g., 0.9) to add some padding
      const scale = Math.min(scaleX, scaleY) * 0.9;

      // Translate to the center of the CSS canvas dimensions
      ctx.translate(cssWidth / 2, cssHeight / 2);
      // Apply the calculated scale
      ctx.scale(scale, scale);
      // Translate the drawing's origin so its original center aligns with the canvas center
      ctx.translate(-designCenterX, -designCenterY);
      // --- End Scaling Logic ---

      let x = 0; // Start epicycles from the (now transformed) origin
      let y = 0;
      const baseLineWidth = 1; // Base line width in design coordinates

      // Draw each Fourier vector (each as a rotating circle and its arrow)
      for (let i = 0; i < fourier.length; i++) {
        let prevX = x;
        let prevY = y;
        const freq = fourier[i].freq;
        const radius = fourier[i].amp; // These amps are now relative to the design size
        const phase = fourier[i].phase;
        x += radius * Math.cos(freq * time + phase);
        y += radius * Math.sin(freq * time + phase);

        // Draw the circle (vector path)
        ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
        // Adjust line width based on scale so it looks consistent
        ctx.lineWidth = baseLineWidth / scale;
        ctx.beginPath();
        ctx.arc(prevX, prevY, radius, 0, 2 * Math.PI);
        ctx.stroke();

        // Draw the vector line
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = baseLineWidth / scale; // Keep line width visually consistent
        ctx.beginPath();
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(x, y);
        ctx.stroke();
      }

      // Add the final tip to the path (relative to the transformed origin)
      path.prepend({ x, y });
      // Optional: Limit path length for performance
      // if (path.length > 700) {
      // // Limit path length slightly longer than points
      // path.pop();
      // }

      // Draw the traced path
      ctx.beginPath();
      if (path.length > 0) {
        // Check if path has points
        ctx.moveTo(path[0].x, path[0].y);
        for (let i = 1; i < path.length; i++) {
          ctx.lineTo(path[i].x, path[i].y);
        }
        ctx.strokeStyle = "#ff4081"; // Pink color
        ctx.lineWidth = (baseLineWidth * 2) / scale; // Make path slightly thicker
        ctx.stroke();
      }

      ctx.restore(); // Restore the state before transformations for this frame

      // Increment time and loop if needed
      time += dt;
      if (time >= 2 * Math.PI) {
        time = time % (2 * Math.PI); // More robust loop than just setting to 0
        path.clear(); // Keep the last point for continuity instead of clearing fully
      }
    } // Uncomment if using frame rate limiting

    // Request the next frame
    animationFrameId = requestAnimationFrame(draw);
  }

  // Add resize listener
  window.addEventListener("resize", resizeCanvas);

  // Initial setup: size the canvas and start the animation
  resizeCanvas();
</script>

{{- partial "home_info.html" . }} {{- end }} {{- $term := .Data.Term }} {{-
range $index, $page := $paginator.Pages }} {{- $class := "post-entry" }} {{-
$user_preferred := or site.Params.disableSpecial1stPost
site.Params.homeInfoParams }} {{- if (and $.IsHome (eq $paginator.PageNumber 1)
(eq $index 0) (not $user_preferred)) }} {{- $class = "first-entry" }} {{- else
if $term }} {{- $class = "post-entry tag-entry" }} {{- end }}

<article class="{{ $class }}">
  {{- $isHidden := (.Param "cover.hiddenInList") | default (.Param
  "cover.hidden") | default false }} {{- partial "cover.html" (dict "cxt" .
  "IsSingle" false "isHidden" $isHidden) }}
  <header class="entry-header">
    <h2 class="entry-hint-parent">
      {{- .Title }} {{- if .Draft }}
      <span class="entry-hint" title="Draft">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="20"
          viewBox="0 -960 960 960"
          fill="currentColor"
        >
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z"
          />
        </svg>
      </span>
      {{- end }}
    </h2>
  </header>
  {{- if (ne (.Param "hideSummary") true) }}
  <div class="entry-content">
    <p>
      {{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}
    </p>
  </div>
  {{- end }} {{- if not (.Param "hideMeta") }}
  <footer class="entry-footer">{{- partial "post_meta.html" . -}}</footer>
  {{- end }}
  <a
    class="entry-link"
    aria-label="post link to {{ .Title | plainify }}"
    href="{{ .Permalink }}"
  ></a>
</article>
{{- end }} {{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer">
  <nav class="pagination">
    {{- if $paginator.HasPrev }}
    <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
      «&nbsp;{{ i18n "prev_page" }}&nbsp; {{- if (.Param "ShowPageNums") }} {{-
      sub $paginator.PageNumber 1 }}/{{ $paginator.TotalPages }} {{- end }}
    </a>
    {{- end }} {{- if $paginator.HasNext }}
    <a class="next" href="{{ $paginator.Next.URL | absURL }}">
      {{- i18n "next_page" }}&nbsp; {{- if (.Param "ShowPageNums") }} {{- add 1
      $paginator.PageNumber }}/{{ $paginator.TotalPages }} {{- end }}&nbsp;»
    </a>
    {{- end }}
  </nav>
</footer>
{{- end }} {{- end }}{{/* end profileMode */}} {{- end }}{{- /* end main */ -}}
